# 微信公众号开发

## 全栈

### 目的 --- 开发者模式

* 将网站嵌入进去公众号菜单里（这里指的是把前端项目的首页链接配置在自定义菜单）
* 实现微信端的独立登录认证、获取微信用户信息、微信支付等高级功能
* UI交互的配置方式

### 开发者文档

* 在我们开发中属于最最最基础和重要的东西了，我们要想熟练开发公众号，首先必须熟读开发者文档！

* 开始前必读、开始开发，属于重点关注对象，也是整个微信开发的基石所在，需要多读几遍。其次是微信网页开发模块的微信网页授权，比较难理解，需要特别注意。其他的模块则根据你们的项目功能需求，有选择性的阅读即可。

### 开发流程

1. 开发环境准备

   * 开发环境准备主要指的是我们项目服务端和微信服务端的网络通讯环境准备

   * IP端口通讯 --> 域名通讯，即服务器基本配置中的URL => 我们各自开发环境需要拥有独立的域名

   * 内网穿透

2. 服务器基本配置

   * AppID 公众号唯一开发识别码 AppSecret 检验公众号开发者身份的密码  ==> access Token

   * URL 服务后端的入口地址

   * Token 公众平台配置的token和后台代码配置的token保持一致 => 微信检验身份

3. 存取access_token参数

   * 公众号调用各接口时都需要使用access_token，access_token的有效期为2小时|7200秒，需定时刷新，重复获取将导致上次获取的access_token失效

   * 如何在有效期内定时刷新获取access_token ？
   * 微信公众号项目是 ==> 单服务架构：可以直接作为静态变量存储在内存里；
   * ==> 多服务架构，可使用中间件存储，Redis、数据库都可以

4. 公众号消息管理

   * 微信公众号的消息交互是通过XML格式进行的

5. 获取 openid 以及网页授权（重难点）

   1. 为什么需要网页授权？我们的目的是什么？
      * 用户在微信客户端中访问第三方网页，公众号可以通过微信网页授权机制，来获取用户基本信息，进而实现业务逻辑。也就是通过这种授权机制，我们能获取微信用户信息，比如：头像、昵称、地区、个性签名等。

   2. 既然目的是获取用户基本信息，微信不是提供了专门的接口吗？非要网页授权？
      * 用户基本信息接口，只需要提供openid或者unionid
      * 微信平台提供了两种方式获取用户的openid
      * 方式一：通过消息交互获取用户信息的方式，用户占主动地位，我们项目后端服务被动接受
      * 方式二：通过网页授权机制主动出击。

   3. 网页授权有哪几种机制？分别是怎样实现？应用于什么场景？
      * 主要有两种机制，对应两种scope：
      * 以 snsapi_base 为scope发起的网页授权，是用来 获取进入页面的用户的openid 的，并且是 静默授权并自动跳转到回调页 的。用户感知的就是直接进入了回调页（往往是业务页面）
      * snsapi_base 获取openid后只能通过用户管理 - 获取用户基本信息(UnionID机制) 接口获取用户基本信息，而这种方式需要确保用户已经关注，不然是没有相关信息的
      * 以 snsapi_userinfo 为scope发起的网页授权，是用来 获取用户基本信息 的。但这种授权 需要用户手动同意 ，并且由于用户同意过，所以 无须关注 ，就可在授权后获取该用户的基本信息
      * snsapi_userinfo 无需用户关注公众号，只要用户点击了授权确认，即可通过access_token和openid调用专门的拉取用户信息接口获取信息

   4. 想要进行网页授权，我们需要在公众平台配置什么吗？
      * 测试号 => 测试号管理-体验接口权限表-网页服务-网页账号 修改 => 配置 回调页面即redirect_uri的域名
      * 正式号（需要微信认证）=> 开发-接口权限-网页服务-网页账号-网页授权获取用户基本信息 修改授权回调域名

## 前端开发者

### 修改本机IP

* C:\WINDOWS\system32\drivers\etc\hosts  => 127.0.0.1 Tab yuexin.com

### 公众平台测试账号

* 修改网页账号 => 域名+IP  => error redirect_uri出错

* 绑定开发者微信号

### 修改config.js文件

```js
  devServer: {
      disableHostCheck: true, // 关闭ip检测
      port: 8088,
      host: '127.0.0.1',
  }
```

### 修改首页文件created

```js
   // 测试账号appid
    let APPID = 'wxaa6d22677b225e03';
    let REDIRECT_URI = location.href
    let url = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${APPID}&response_type=code&scope=snsapi_userinfo&state=STATE&redirect_uri=${REDIRECT_URI}&#wechat_redirect`;
    location.href = url
```

* 判断移动端类型及是否是微信内置浏览器 navigator.userAgent
* 通过识别 MicroMessenger 关键字来确定是否微信内置的浏览器
* navigator.userAgent.toLowerCase().match(/MicroMessenger/i) == "micromessenger"
* navigator.userAgent.toLowerCase().indexOf("alipay") != -1
* 配置文件中的`"extends": "eslint:recommended"`属性启用此规则  -- 禁用debugger；删除即关闭

## 大庆公众号开发分析

1. 使用`vue create mypro`创建一个vue项目[webapp]

2. 在入口文件首页定义url重定向实现授权

   * 首页

   ```js
   // 授权-登录验证
   // 初次登录 -> 重定向，获取code -> 换openid
   getUserInfo(){
      // 判断移动端类型及是否是微信内置浏览器 navigator.userAgent
      // 通过识别 MicroMessenger 关键字来确定是否微信内置的浏览器
      // 微信端
      if(navigator.userAgent.toLowerCase().match(/MicroMessenger/i) == "micromessenger") {
         console.log('微信端');
         this.uCode = this.getParam('code')//取url中的参数code
         if (this.uCode == null) {
            //网页授权（记得改appid）
            let APPID = 'wxaa6d22677b225e03'; // 自己
            let REDIRECT_URI = location.href;
            let url = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${APPID}&response_type=code&scope=snsapi_userinfo&state=STATE&redirect_uri=${REDIRECT_URI}&#wechat_redirect`;
            location.href = url
         } else {
            // 已有uCode，判断是否已绑定
            this.checkBind();  
         }
      } else if (navigator.userAgent.toLowerCase().indexOf("alipay") != -1) {
         console.log('支付宝生活号');
         this.uCode = this.getParam('auth_code')//取url中的参数code
         if(this.uCode == null) {
            let APPID = 2019081266215218;
            let REDIRECT_URI = location.href;
            let url = `https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?app_id=${APPID}&scope=auth_user&redirect_uri=${REDIRECT_URI}`;
            location.href = url
         } else {
            // 获取个人信息
            this.aliCheckBind()
         }
      }
   },
   ```

3. 在main.js文件定义页面标题，全局函数定义|引入，创建vue实例

   * main.js

   ```js
   //微信授权、检测登录
   router.beforeEach((to, from, next) => {
      window.document.title = to.meta.title //页面标题
      if(to.path == '/feedback'){
         sessionStorage.setItem('toPath',to.path) //存储前往路由
      }else{
         if(to.path != '/account/login' && sessionStorage.getItem('toPath')){
            sessionStorage.removeItem('toPath')
         }
      }
   })
   ```
